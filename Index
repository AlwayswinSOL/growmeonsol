<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weed Plant Market Cap Room</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      background: #050508;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      color: #f5f5f5;
    }

    canvas {
      display: block;
    }

    #hud {
      position: fixed;
      top: 16px;
      left: 16px;
      padding: 10px 14px;
      background: rgba(5, 5, 10, 0.85);
      border-radius: 10px;
      color: #e5ffe5;
      box-shadow: 0 0 18px rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(120, 255, 120, 0.25);
      min-width: 220px;
      z-index: 10;
    }

    #hud-title {
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #88ff99;
      margin-bottom: 4px;
    }

    #hud-token {
      font-size: 14px;
      margin-bottom: 6px;
      opacity: 0.85;
    }

    #marketCapText {
      font-size: 16px;
      font-weight: 600;
      color: #b6ffb6;
      margin-bottom: 4px;
    }

    #priceText {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 2px;
    }

    #heightText {
      font-size: 12px;
      opacity: 0.75;
    }

    #statusText {
      font-size: 11px;
      margin-top: 6px;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div id="hud">
    <div id="hud-title">Market Growth Visualizer</div>
    <div id="hud-token">JOHN BUMMIT / SOL (PumpSwap)</div>
    <div id="marketCapText">MC: loading…</div>
    <div id="priceText">Price: loading…</div>
    <div id="heightText">Plant height: loading…</div>
    <div id="statusText">Status: connecting to DexScreener…</div>
  </div>

  <!-- Three.js from CDN -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    // ---------- CONFIG ----------
    const DEX_SCREENER_URL =
      "https://api.dexscreener.com/latest/dex/pairs/solana/a614mactswolq4blkm1tj1hgs1ftabtx9cbpk83pxkxq"; // John Bummit / SOL pair[web:51][web:53]

    const REFRESH_MS = 10_000;

    // ---------- DOM ELEMENTS ----------
    const hudMc   = document.getElementById("marketCapText");
    const hudP    = document.getElementById("priceText");
    const hudH    = document.getElementById("heightText");
    const hudStat = document.getElementById("statusText");

    // ---------- THREE.JS SETUP ----------
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050508);

    const camera = new THREE.PerspectiveCamera(
      50,
      window.innerWidth / window.innerHeight,
      0.1,
      100
    );
    camera.position.set(3.5, 2.2, 4.2);
    camera.lookAt(0, 1.0, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;
    controls.target.set(0, 1.0, 0);

    // ---------- ROOM ----------
    const roomSize = 6;

    // Floor
    const floorGeo = new THREE.PlaneGeometry(roomSize, roomSize);
    const floorMat = new THREE.MeshStandardMaterial({
      color: 0x1a1a1e,
      roughness: 0.8,
      metalness: 0.05,
    });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2;
    floor.position.y = 0;
    floor.receiveShadow = true;
    scene.add(floor);

    // Walls
    const wallMat = new THREE.MeshStandardMaterial({
      color: 0x111118,
      roughness: 0.9,
      metalness: 0.0,
    });

    const wallGeo = new THREE.PlaneGeometry(roomSize, roomSize / 1.5);

    const backWall = new THREE.Mesh(wallGeo, wallMat);
    backWall.position.set(0, roomSize / 3, -roomSize / 2);
    scene.add(backWall);

    const leftWall = new THREE.Mesh(wallGeo, wallMat);
    leftWall.rotation.y = Math.PI / 2;
    leftWall.position.set(-roomSize / 2, roomSize / 3, 0);
    scene.add(leftWall);

    const rightWall = new THREE.Mesh(wallGeo, wallMat);
    rightWall.rotation.y = -Math.PI / 2;
    rightWall.position.set(roomSize / 2, roomSize / 3, 0);
    scene.add(rightWall);

    // ---------- LIGHTING ----------
    const ambient = new THREE.AmbientLight(0xffffff, 0.35);
    scene.add(ambient);

    const spot = new THREE.SpotLight(0xffffff, 1.3, 20, Math.PI / 4, 0.35, 1.2);
    spot.position.set(2.5, 5, 2.5);
    spot.castShadow = true;
    spot.shadow.mapSize.set(1024, 1024);
    scene.add(spot);

    const spotTarget = new THREE.Object3D();
    spotTarget.position.set(0, 1, 0);
    scene.add(spotTarget);
    spot.target = spotTarget;

    // Small colored accent light
    const accent = new THREE.PointLight(0x33ff99, 0.4, 10);
    accent.position.set(-2.5, 2.0, 2.0);
    scene.add(accent);

    // ---------- PLANT (STEM + LEAVES) ----------
    const plantGroup = new THREE.Group();
    scene.add(plantGroup);

    // Pot
    const potGeo = new THREE.CylinderGeometry(0.35, 0.45, 0.45, 24);
    const potMat = new THREE.MeshStandardMaterial({
      color: 0x3b2a21,
      roughness: 0.8,
      metalness: 0.1,
    });
    const pot = new THREE.Mesh(potGeo, potMat);
    pot.castShadow = true;
    pot.receiveShadow = true;
    pot.position.y = 0.225;
    plantGroup.add(pot);

    // Soil
    const soilGeo = new THREE.CylinderGeometry(0.34, 0.34, 0.08, 24);
    const soilMat = new THREE.MeshStandardMaterial({
      color: 0x141814,
      roughness: 0.9,
    });
    const soil = new THREE.Mesh(soilGeo, soilMat);
    soil.position.y = pot.position.y + 0.18;
    soil.receiveShadow = true;
    plantGroup.add(soil);

    // Stem (scaled in Y for growth)
    const stemGeo = new THREE.CylinderGeometry(0.04, 0.06, 1, 10);
    const stemMat = new THREE.MeshStandardMaterial({
      color: 0x1b7b32,
      roughness: 0.6,
      metalness: 0.05,
    });
    const stem = new THREE.Mesh(stemGeo, stemMat);
    stem.castShadow = true;
    stem.receiveShadow = true;

    const stemPivot = new THREE.Object3D();
    stemPivot.position.set(0, soil.position.y + 0.05, 0);
    stem.position.y = 0.5;
    stemPivot.add(stem);
    plantGroup.add(stemPivot);

    // Simple leaves
    const leafGeo = new THREE.PlaneGeometry(0.5, 0.18);
    const leafMat = new THREE.MeshStandardMaterial({
      color: 0x22aa44,
      side: THREE.DoubleSide,
      roughness: 0.5,
      metalness: 0.05,
    });

    function createLeaf(angle, heightFactor, bend) {
      const leaf = new THREE.Mesh(leafGeo, leafMat);
      leaf.castShadow = true;
      leaf.receiveShadow = true;
      leaf.position.y = heightFactor;
      leaf.rotation.y = angle;
      leaf.rotation.z = bend;
      leaf.position.x = Math.cos(angle) * 0.08;
      leaf.position.z = Math.sin(angle) * 0.08;
      stemPivot.add(leaf);
      return leaf;
    }

    const leaves = [];
    for (let i = 0; i < 6; i++) {
      const a = (i / 6) * Math.PI * 2;
      const h = 0.2 + (i % 3) * 0.25;
      const b = (i % 2 === 0 ? 1 : -1) * 0.35;
      leaves.push(createLeaf(a, h, b));
    }

    plantGroup.position.set(0, 0, 0);

    // ---------- MARKET CAP LOGIC ----------
    let currentHeight = 1.0;
    let targetHeight = 1.0;
    let plantSwayPhase = 0;

    function marketCapToHeight(mc) {
      if (!mc || mc <= 0) return 0.8;
      const log = Math.log10(mc); // compress huge numbers[web:56]
      const h = 0.22 * log + 0.4; // tweak multiplier/offset to taste
      return Math.max(0.6, Math.min(h, 3.5));
    }

    async function fetchMarketData() {
      try {
        hudStat.textContent = "Status: fetching from DexScreener…";
        const res = await fetch(DEX_SCREENER_URL);
        const json = await res.json();

        const pair = json.pairs?.[0];
        if (!pair) {
          hudStat.textContent = "Status: pair not found.";
          return;
        }

        const priceUsd = Number(pair.priceUsd || 0);
        const mc =
          Number(pair.fdv || 0) ||
          Number(pair.marketCap || 0) ||
          0;

        // Update HUD
        if (mc > 0) {
          hudMc.textContent =
            "MC: $" + Math.round(mc).toLocaleString();
        } else {
          hudMc.textContent = "MC: n/a";
        }

        if (priceUsd > 0) {
          hudP.textContent =
            "Price: $" +
            (priceUsd < 0.01 ? priceUsd.toPrecision(3) : priceUsd.toFixed(4));
        } else {
          hudP.textContent = "Price: n/a";
        }

        targetHeight = marketCapToHeight(mc);
        hudH.textContent = "Plant height: " + targetHeight.toFixed(2) + "x";

        hudStat.textContent = "Status: live from DexScreener (10s refresh).";
      } catch (err) {
        console.error(err);
        hudStat.textContent = "Status: error fetching data.";
      }
    }

    fetchMarketData();
    setInterval(fetchMarketData, REFRESH_MS);

    // ---------- ANIMATION LOOP ----------
    const clock = new THREE.Clock();

    function animate() {
      requestAnimationFrame(animate);
      const dt = clock.getDelta();
      const t = clock.getElapsedTime();

      // Smooth growth/shrink
      const lerpFactor = 0.08;
      currentHeight += (targetHeight - currentHeight) * lerpFactor;

      // Apply scale only on Y for stem
      stemPivot.scale.y = currentHeight;

      // Gentle sway based on time
      plantSwayPhase += dt * 0.8;
      const sway = Math.sin(plantSwayPhase) * 0.08;
      stemPivot.rotation.z = sway;

      // Slight breathing of leaves
      const leafPulse = 0.05 * Math.sin(t * 1.6);
      leaves.forEach((leaf, i) => {
        const dir = i % 2 === 0 ? 1 : -1;
        leaf.rotation.z += leafPulse * dir * 0.02;
      });

      controls.update();
      renderer.render(scene, camera);
    }

    animate();

    // ---------- RESIZE ----------
    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
